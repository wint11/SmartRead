# CTF 设计与隐藏机制

## 核心概念
SmartRead 是一个伪装成功能齐全的小说阅读网站的 **"Capture The Flag" (CTF) 靶场平台**。其目标是在真实环境中教授 Web 安全概念 (OWASP Top 10)。玩家扮演“读者”，在无意中发现安全漏洞。

## 挑战分类
挑战分为以下几类：
*   **Web**: 前端/后端漏洞 (XSS, SQL注入, IDOR, 逻辑漏洞)。
*   **System**: Linux/服务器配置错误 (模拟)。
*   **Crypto**: 加密与编码谜题。
*   **Misc**: 彩蛋与逻辑谜题。

## 详细挑战设计

### 1. 百万富翁俱乐部 (Web / 逻辑)
*   **位置**: 个人中心 (`/profile`) -> 钱包卡片。
*   **场景**: 用户看到一个“充值”按钮，增加虚拟货币。有一个售价 1,000,000 金币的 VIP 会员资格。
*   **漏洞**: **不安全的 Cookie 存储**。
    *   余额存储在名为 `shop_session` 的 Cookie 中。
    *   格式: `{"balance": 1000, "sign": "md5(balance + secret)"}`。
    *   密钥很弱，或者验证逻辑允许 "none" 算法（逻辑缺陷）。
*   **解法**:
    1.  检查浏览器 Cookies。
    2.  解码 JSON 数据。
    3.  修改 `balance` 为 `1000000`。
    4.  伪造签名（或如果验证有缺陷则绕过）。
    5.  刷新页面并购买 VIP 会员，即可获得 Flag。

### 2. 付费墙绕过 (Web / 前端)
*   **位置**: 任何“VIP”章节（例如某本书的第 2 章）。
*   **场景**: 内容被“订阅以阅读”的遮罩层阻挡。
*   **漏洞**: **客户端安全控制失效**。
    *   服务器发送了完整内容，但 CSS 设置了 `filter: blur(5px)` 并覆盖了一个 div。
*   **解法**:
    1.  右键 -> 检查元素 (Inspect Element)。
    2.  删除遮罩层 `div`。
    3.  移除内容容器的 `blur` 类。
    4.  Flag 隐藏在章节文本中。

### 3. 幽灵模式 (Misc / 彩蛋)
*   **位置**: 阅读器视图。
*   **触发条件**: 快速点击章节标题 5 次。
*   **效果**:
    *   界面出现故障特效 (CSS 动画)。
    *   出现一个隐藏的聊天界面（与“幽灵”或“前任黑客”对话）。
*   **奖励**: 提供其他挑战的线索以及一个特定的“幽灵 Flag”。

### 4. 模拟操作系统 (System / Web)
*   **位置**: `/hidden_directory` (通过 `robots.txt` 或源码分析发现)。
*   **设计**: 基于 React 的桌面环境 (Windows 95/Linux 风格)。
*   **功能**:
    *   **文件管理器**: 浏览伪造的系统文件。
    *   **终端**: 运行基础命令 (`ls`, `cat`, `whoami`)。
    *   **记事本**: 阅读管理员留下的“便条”。
*   **漏洞**: **路径遍历 / 信息泄露**。
    *   在深层目录中找到名为 `passwords.txt` 或类似的文件。
    *   使用终端“利用”伪造的二进制文件。

### 5. 时间裂缝 (Misc / 时机)
*   **位置**: 阅读器视图。
*   **机制**: 一个检查 `new Date().getSeconds()` 的组件。
*   **触发条件**: 仅当秒数在 `:42` 到 `:45` 之间时渲染一个“传送门”按钮。
*   **挑战**: 用户必须善于观察或检查 React 组件以发现条件渲染逻辑。

### 6. 终端界面 (`/ctf`)
*   **概述**: 提交 Flag 和追踪进度的中心枢纽。
*   **技能树**: 可视化进度。随着 Flag 的提交解锁节点。
*   **命令**:
    *   `submit <flag>`: 验证 Flag。
    *   `hint <id>`: 花费积分获取提示。
    *   `top`: 显示排行榜（模拟或真实）。

## 实现说明
*   **Flag 格式**: `flag{...}`
*   **验证**: Flag 通过 Server Actions 在服务端验证，防止前端直接查看 Flag 数据库（纯前端挑战除外）。
*   **状态**: 用户进度保存在数据库中（游客模式下保存在本地存储）。

## CTF 框架内部实现

### 1. Flag 注册系统
本项目采用集中式注册模式管理 Flag，确保类型安全且易于维护。
- **位置**: `src/lib/ctf/flags/`
- **结构**: Flag 按类别分拆 (`web.ts`, `system.ts` 等) 并在 `index.ts` 中汇总。
- **定义**:
  ```typescript
  export const WEB_FLAGS = {
    1: "flag{...}", // ID: Flag 内容
  } as const
  ```

### 2. 提交流程
1.  **用户输入**: 用户在模拟终端中输入 `submit <flag>` (`src/app/ctf/commands/game.ts`)。
2.  **Server Action**: 客户端调用 `src/app/ctf/actions.ts` 中的 `verifyFlag(flag)`。
3.  **验证逻辑**:
    *   服务端对输入进行标准化处理 (去除首尾空格)。
    *   遍历 `FLAGS` 对象的值以查找匹配项。
    *   **安全性**: Flag 列表从未发送给客户端。仅返回结果（成功/失败）。
4.  **状态更新**:
    *   **成功**: 返回 Flag ID。客户端更新 `solvedFlags` 状态及 localStorage。
    *   **失败**: 触发“炸弹”机制（加速倒计时）。

### 3. 挑战元数据
UI 中展示的挑战信息与 Flag 定义分离，以便在不暴露 Flag 的情况下提供提示和描述。
- **位置**: `src/app/ctf/data/challenges.ts`
- **字段**: `id`, `title` (标题), `description` (描述), `hint` (提示), `points` (分数), `category` (分类)。

### 4. 开发者指南：如何添加新 Flag
1.  **定义 Flag**: 在 `src/lib/ctf/flags/<category>.ts` 中添加新条目。
2.  **创建任务**: 在 `src/app/ctf/data/challenges.ts` 中添加挑战元数据。
3.  **实现触发器**:
    *   **前端**: 在 React 组件中添加隐藏元素、Console 日志或特定交互。
    *   **后端**: 在 API 路由或 Server Action 中添加逻辑检查（例如：特定的 SQL 注入 Payload）。
